{% extends 'base.html' %}
{% load mytags %}
{% block content %}

<div class="row">
    <div class="col-md-12">
        <!-- BEGIN EXAMPLE TABLE PORTLET-->
        <div class="portlet light bordered">
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="btn-group">
                                <button id="add-dbbackup" class="btn sbold green" data-toggle="modal">
                                    添加数据库备份
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group pull-right">
                                <button class="btn green  btn-outline " id="del_btn">删除所选
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <table class="table table-striped table-bordered table-hover table-checkable order-column"
                       id="table_dbback">
                    <thead>
                    <tr>
                        <th>
                            <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                <input type="checkbox" class="group-checkable" data-set="#sample_1 .checkboxes"
                                       id="select_all" name="select_all"/>
                                <span></span>
                            </label>
                        </th>
                        <th>代理名称</th>
                        <th>任务配置</th>
                        <th>任务状态</th>
                        <th>最后执行时间状态</th>
                        <th>备注</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- END EXAMPLE TABLE PORTLET-->
    </div>
</div>
{% include 'backupManage/dbback/tab.html' %}
{% endblock %}
{% block self_head_css_js %}
{% include 'backupManage/dbback/css.html' %}
{% endblock %}

{% block self_footer_js %}
{% include 'backupManage/dbback/js.html' %}
<!-- start custom define scripts-->
<script>
$(document).ready(function () {
    // 获取当前日期时间串
    function get_nowdate(formatDate) {
        var d = new Date();
        var year = d.getFullYear();
        var month = d.getMonth() + 1;
        var day = d.getDate();
        var hour = d.getHours();
        var minute = d.getMinutes();
        var second = d.getSeconds();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (day >= 0 && day <= 9) {
            day = "0" + day;
        }

        return year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second
    }

    // 重复周期选择
    $("select[name='trigger_cycle']").change(function (even, opt) {
        var sel_val = $("select[name='trigger_cycle'] option:selected").val();

        // 除了一次性之外都是显示，默认是显示
        $("#div_hour").attr('class', "form-group");
        $("#div_minute").attr('class', "form-group");
        $("#div_second").attr('class', "form-group");

        // 只有自定义时才是显示，默认为隐藏
        $("#div_define").attr('class', "form-group display-hide");
        if (sel_val == "1") {
            $("#div_hour").attr('class', "form-group display-hide");
            $("#div_minute").attr('class', "form-group display-hide");
            $("#div_second").attr('class', "form-group display-hide");
        } else if (sel_val == "2") {
            console.log("day");
        } else if (sel_val == "3") {
            console.log("week");
        } else if (sel_val == "4") {
            console.log("month");
        } else if (sel_val == "5") {
            console.log("define");
            $("#div_define").attr('class', 'form-group');
        }
    });

    // 重复类型选择
    $("select[name='cycle_type']").change(function (even, opt) {
        var sel_val = $("select[name='cycle_type'] option:selected").val();
        var type_val = $("select[name='cycle_type_val']").empty();
        if (sel_val == 1) {
            var arr = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六");
            $.each(arr, function (i, item) {
                type_val.append("<option value=" + i + ">" + item + "</option>");
            });
        } else {
            var arr = new Array(31);
            $.each(arr, function (i, item) {
                type_val.append("<option value=" + (i + 1) + ">" + (i + 1) + "日</option>");
            });
        }
    });

    // proxy选择加载主机信息
    $("select[name='proxy']").change(function (even, assets) {
        $.ajax({
            type: "post",
            url: "{% url 'get_host_for_proxy' %}",
            dataType: "json",
            data: {"proxy_id": $("select[name='proxy'] option:selected").val()},
            success: function (data) {
                $("select[name='proxy_host']").empty();
                if (assets == undefined) {
                    $.each(data, function (i, item) {
                        $("select[name='proxy_host']").append("<option value=" + item.id + ">" + item.name + "</option>");
                    });
                } else {
                    $.each(data, function (i, item) {
                        var is_selected = false;
                        $.each(assets.resource, function (j, asset) {
                            if (asset.id == item.id) {
                                is_selected = true;
                            }
                        });

                        if (is_selected) {
                            $("select[name='proxy_host']").append("<option selected value=" + item.id + ">" + item.name + "</option>");
                        } else {
                            $("select[name='proxy_host']").append("<option value=" + item.id + ">" + item.name + "</option>");
                        }
                    });
                }

            }
        });

    });

    <!-- 添加数据库备份 -->
    $("#add-dbbackup").click(function () {
        // 初始化表单内容
        $("#form_sample_1")[0].reset();
        // 设置modal titile
        $("#dbbackup_modal .modal-title").text('添加数据库备份');
        // 设置隐藏sbtype 为add
        $("#sbtype").val('add');
        // 激活第一个tab页
        $("#dbTab ul li").attr('class', '');
        $("#dbTab ul li:eq(0)").attr('class', 'active');
        $("#dbTab .tab-content div.tab-pane").attr('class', 'tab-pane');
        $("#dbTab .tab-content div.tab-pane:eq(0)").attr('class', 'tab-pane active');
        // 设置开始日期为当前日期
        $("input[name='start_datetime']").val(get_nowdate(''));

        // 获取proxy信息
        $.ajax({
            type: 'GET',
            url: "{% url 'dbbackup_add' %}",
            success: function (result) {
                result = $.parseJSON(result);
                // 初始化proxy信息
                var proxys = result.proxys;
                $("select[name='proxy']").empty();

                $.each(proxys, function (i, item) {
                    $("select[name='proxy']").append(("<option value='" + item.id + "'>" + item.proxy_name + "</option>"));
                });

                // 初始化任务主机内容
                $("select[name='proxy']").trigger("change");

                // 初始化触发器选择
                var trigger_obj = $("select[name='trigger_cycle']").empty();
                var c_week = "周" + "日一二三四五六".split("")[new Date().getDay()];
                trigger_obj.append("<option value='1'>一次性活动</option>");
                trigger_obj.append("<option value='2'>每天</option>");
                trigger_obj.append("<option value='3'>每周（" + c_week + "）</option>");
                trigger_obj.append("<option value='4'>每月（" + new Date().getDate() + "日）</option>");
                trigger_obj.append("<option value='5'>自定义</option>");

                // 显示modal
                $('#dbbackup_modal').modal({backdrop: 'static', keyboard: false});
            }
        });

    });

    <!-- 初始化首页表单数据 -->
    $("#table_dbback").dataTable({
        "destroy": true,                        //如果这个tab初始化过，将会先销毁再初始化
        "bAutoWidth": false,                    //不自动计算列宽度
        "aoColumns": [                          //设定各列宽度
            {
                "mData": "id",           //指定列名，在后台程序回显时，根据名字查找
                "sWidth": "5%",
                "bSortable": true,
                "bSearchable": false
            },
            {
                "mData": "proxy",
                "sWidth": "15%",
                "bSortable": true
            },
            {
                "mData": "b_trigger",
                "sWidth": "20%",
                "bSortable": false,
                "bSearchable": false
            },
            {
                "mData": "status",
                "sWidth": "15%",
                "bSortable": true,
                "bSearchable": false
            },
            {
                "mData": "last_exec_time",
                "sWidth": "20%",
                "bSortable": false,
                "bSearchable": false
            },
            {
                "mData": "comment",
                "sWidth": "15%",
                "bSortable": false
            },
            {
                "mData": "id",
                "bSortable": false,
                "bSearchable": false
            }
        ],
        "aaSorting": [
            [0, "desc"]
        ], //默认排序
        "bProcessing": true,                    //加载数据时显示正在加载信息
        "bServerSide": true,                    //指定从服务器端获取数据
        "bFilter": true,                       //不使用过滤功能
        "bLengthChange": true,                 //改变每页显示数量
        "sAjaxSource": "{% url 'dbbackup_list' %}",//获取数据的url
        //获取数据的处理函数
        "fnServerData": function (sSource, aoData, fnCallback, oSettings) {
            $.ajax({
                type: 'POST',
                url: sSource,
                dataType: "json",
                data: aoData,
                success: function (resp) {
                    fnCallback(resp);
                }
            });
        },
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            if (aData.status == '00') {
                $('td:eq(3)', nRow).html("启用");
            } else if (aData.status == '01') {
                $('td:eq(3)', nRow).html("暂停");
            } else {
                $('td:eq(3)', nRow).html("销毁");
            }

            // 设置操作连接
            var op_div = '<div class="btn-group">' +
                    '<button class="btn btn-xs green dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false"> ' +
                    'Actions ' +
                    '<i class="fa fa-angle-down">' +
                    '</i>' +
                    '</button>' +
                    '<ul class="dropdown-menu" role="menu">' +
                    '    <li>' +
                    '        <a href="#" name="view">查看明细</a>' +
                    '    </li>' +
                    '    <li>' +
                    '        <a href="#" name="disable">禁用</a>' +
                    '    </li>' +
                    '    <li>' +
                    '       <a href="#" name="enable">启用</a>' +
                    '    </li>' +
                    '    <li>' +
                    '        <a data-toggle="modal" href="#" name="edit">编辑</a>' +
                    '    </li>' +
                    '    <li>' +
                    '        <a href="#" name="del">删除</a>' +
                    '    </li>' +
                    '</ul>' +
                    '</div>'
            $('td:eq(6)', nRow).html(op_div);
        },

        // 此处参考的是table-datables-managed.min.js
        language: {
            aria: {
                sortAscending: ": activate to sort column ascending",
                sortDescending: ": activate to sort column descending"
            },
            emptyTable: "No data available in table",
            info: "Showing _START_ to _END_ of _TOTAL_ records",
            infoEmpty: "No records found",
            infoFiltered: "(filtered1 from _MAX_ total records)",
            lengthMenu: "Show _MENU_",
            search: "Search:",
            zeroRecords: "No matching records found",
            paginate: {
                previous: "Prev",
                next: "Next",
                last: "Last",
                first: "First"
            }
        },
        pagingType: "bootstrap_full_number",
        lengthMenu: [
            [5, 15, 20, -1],
            [5, 15, 20, "All"]
        ],
        pageLength: 5
    });
    // 时间选择器格式设置
    $(".form-datetime").datetimepicker({
        format: "yyyy-mm-dd hh:ii:ss",
        weekStart: 1,
        startView: "year",
        todayBtn: true,
        todayHighlight: true,//是否高亮当前时间
        keyboardNavigation: true,//是否允许键盘选择时间
        minuteStep: 5,//分钟的间隔
        showMeridian: true, //是否加上网格
        language: 'zh-CN',//选择语言，前提是该语言已导入
        pickerPosition: "bottom-left",
        forceParse: true,//当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
        autoclose: true//当选择一个日期之后是否立即关闭此日期时间选择器
    });

});
</script>
{% endblock %}