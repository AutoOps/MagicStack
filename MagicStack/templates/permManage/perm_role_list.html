{% extends 'base.html' %}
{% load mytags %}
{% block self_head_css_js %}
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <link href="/static/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
        <link href="/static/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
        <!-- END PAGE LEVEL PLUGINS -->
        <link href="/static/global/plugins/bootstrap-toastr/toastr.min.css" rel="stylesheet" type="text/css" />
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="/static/global/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
        <link href="/static/global/css/plugins.min.css" rel="stylesheet" type="text/css" />
        <!-- END THEME GLOBAL STYLES -->
{% endblock %}
{% block content %}
{% include 'nav_cat_bar.html' %}

<div class="row">
    <div class="col-md-12">
        <!-- BEGIN EXAMPLE TABLE PORTLET-->
        <div class="portlet light bordered">
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="btn-group">
                                <button id="add_groups" class="btn sbold green">添加系统用户
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1">
                    <thead>
                        <tr>
                            <th> 名称 </th>
                            <th> sudo别名 </th>
                            <th> 创建时间 </th>
                            <th> 操作 </th>
                        </tr>
                    </thead>
                    <tbody>
                            {% for role in roles %}
                            <tr class="gradeX">
                                <td> <a href="{% url 'role_detail' %}?id={{ role.id }}">{{ role.name }} </a> </td>
                                <td> {{ role | role_contain_which_sudos }} </td>
                                <td> {{ role.date_added | date:"Y-m-d H:i:s"}} </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-xs green dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false"> Actions
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li>
                                                <a href="{% url 'role_edit' %}?id={{ role.id }}" >
                                                    编辑 </a>
                                            </li>
                                            <li>
                                                <a href="{% url 'role_push' %}?id={{ role.id }}">
                                                    推送 </a>
                                            </li>
                                            <li>
                                                <a name="{% url 'role_del' %}?id={{ role.id }}" class="del">
                                                     删除 </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- END EXAMPLE TABLE PORTLET-->
    </div>
</div>

{% endblock %}
{% block self_footer_js %}
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/static/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/static/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/static/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/static/pages/scripts/table-datatables-managed.min.js" type="text/javascript"></script>
    <script src="/static/global/plugins/bootstrap-toastr/toastr.min.js" type="text/javascript"></script>
    <script src="/static/pages/scripts/ui-toastr.min.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL SCRIPTS -->
<script>
      $(document).ready(function(){
          $('#add_groups').click(function(){
              window.location.href = "{% url 'role_add' %}"
          });

          $('.del').click(function(){
              var row = $(this).closest('tr');
              var url_r = $(this).attr('name');
              var role_id = url_r.split('?')[1].split('=')[1];
              $.ajax({
                    type: "GET",
                    url: "{% url 'role_del' %}",
                    data: {id: role_id, filter_type: 'recycle_assets'},
                    success: function(data) {
                        console.log(data);
                        if (data) {
                            msg = data + "的系统用户会被删除，包括其家目录，请谨慎操作!"
                        }
                        else {
                            msg = "该角色无已推送的系统用户, 可以安全删除"
                        }
                        if (confirm(msg)) {
                            $.ajax({
                               type: "POST",
                               url: "{% url 'role_del' %}",
                               data: "id=" + role_id,
                               success: function(msg){
                                   alert( "成功: " + msg );
                                   row.remove()
                               },
                               error: function (msg) {
                                   console.log(msg);
                                   alert("失败: " + msg.responseText)
                               }
                            });
                        }
                    },
                    error: function(error) {
                        alert(error)
                    }
              });
          });

            //定时器
          function showalert() {
               $.ajax({
                  url: '{% url 'push_role_event' %}',
                  method: 'get',
                  success: function(res) {
                        toastr['success'](res.message);
                        toastr.options = {
                          "closeButton": true,
                          "debug": false,
                          "positionClass": "toast-top-right",
                          "onclick": null,
                          "showDuration": "1000",
                          "hideDuration": "1000",
                          "timeOut": "5000",
                          "extendedTimeOut": "1000",
                          "showEasing": "swing",
                          "hideEasing": "linear",
                          "showMethod": "fadeIn",
                          "hideMethod": "fadeOut"
                        }
                  }
               });
           }
            //定时执行，10秒后执行showalert()
            window.setInterval(function(){
            showalert();
            },10000);
      })
</script>
{% endblock %}



